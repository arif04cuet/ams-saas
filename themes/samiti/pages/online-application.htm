title = "Online Application"
url = "/online-application"
layout = "default"
is_hidden = 0
==
<?php
use Techpanda\Core\Models\UserProfile;
use Techpanda\Core\Models\MemberRoll;
use Backend\Models\User;
use System\Models\File as File;

function onStart(){
    $this['rollList'] = MemberRoll::all();
}

function onSubmitRoll(){
    $this['member']  = MemberRoll::find(post('roll_id'));
    $this['cadres']  =$cadres =  User::select(['cadre'])
                                ->pluck('cadre')
                                ->unique()
                                ->filter()
                                ->values()
                                ->all();
    return [
        '#new_application_form'=> $this->renderPartial('newApplication/form')
    ];
}

function onPhotoUpload(){
    $image = Input::all();
    $file = (new File())->fromPost($image['avatar']);
    return [
    '#avatarPreview'=>'<img src="'. $file->getThumb(200, 200, ['mode' => 'crop']).'">'
    ];
}

function onSubmitApplication(){

    $data = post();

    $rules=
    [
        'user.first_name'=>'required',
        'user.fullname_bn'=>'required',
        'user.email' => 'required|between:6,255|email|unique:backend_users,email',
        'user.mobile'=>'required',
        'user.cadre'=>'required',
        'profile.mobile'=>'required',
        'user.designation'=>'required',
        'user.office_name'=>'required',
        'profile.roll'=>'required',
        'profile.nid'=>'required',
        'profile.dob'=>'required',
        'profile.sex'=>'required',
        'profile.present_house_no'=>'required',
        'profile.present_road_no'=>'required',
        'profile.present_address'=>'required',
        'profile.permanent_house_no'=>'required',
        'profile.permanent_road_no'=>'required',
        'profile.permanent_address'=>'required',

    ];

    $messages = [
    'required'=>'This field is required'
    ];

    $validator = Validator::make($data,$rules,$messages);

    if($validator->fails())
        throw new ValidationException($validator);


    DB::transaction(function() use($data){

    $userData = $data['user'];
    $userData['association_id'] = 1;
    $userData['login'] = uniqid();
    $userData['is_activated'] = false;
    $userData['password'] = UserProfile::DEFAULT_PASSWORD;
    $userData['password_confirmation'] = UserProfile::DEFAULT_PASSWORD;

    //save user
    $user = User::create($userData);
    $user->role = Backend\Models\UserRole::where('code','member')->first();

    if (Input::hasFile('avatar'))
    $user->avatar = Input::file('avatar');


    $user->save();

    //save profile
    $profileData = array_filter($data['profile']);
    $profileData['user_id'] = $user->id;
    $profile = UserProfile::create($profileData);

    // fire event
    Event::fire('online.application.submitted', [$user]);

    });

    Flash::success(Lang::get('techpanda.core::lang.frontend.online_form_success_message'));

    return [
    '#avatarPreview'=>''
    ];

}

?>
==
<h3>Online application</h3>
<hr>
<div>
 {% content 'new_member_application_help'%}

</div>

<div>

   <form data-request-files data-request-validate data-request-flash
    >
    {{ form_sessionKey()}}
    {{ form_token()}}

    <div class="form-row">

        <div class="form-group col-md-6 ">
            <label for="avatar">Select Name & Roll </label>
            <select class="form-control" name="roll_id"  data-request="onSubmitRoll" >
            <option value="">Select</option>
            {% for roll in rollList %}
            <option value="{{roll.id}}">{{roll.name ~ '-'~ roll.roll}}</option>
            {% endfor %}
            </select>
        </div>

    </div>
    </form>
</div>

<div id="new_application_form">
</div>